{% extends "base.html" %}

{% block extra_css %}
<style>
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .form-group label .required {
        color: #e74c3c;
        margin-left: 3px;
    }
    
    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #66a6ff;
    }
    
    .form-group textarea {
        min-height: 120px;
        resize: vertical;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }
    
    .file-upload {
        border: 3px dashed #66a6ff;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #e3f9ff;
    }
    
    .file-upload:hover {
        border-color: #89f7fe;
        background: #d4efff;
    }
    
    .file-upload input {
        display: none;
    }
    
    .upload-icon {
        font-size: 2em;
        margin-bottom: 10px;
        color: #66a6ff;
    }
    
    .current-image {
        max-width: 300px;
        border-radius: 10px;
        margin: 10px 0;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 30px;
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .loading.show {
        display: block;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #66a6ff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 30px; color: #2c3e50;">âœï¸ å¤§ä¼šæƒ…å ±ç·¨é›†</h2>
    
    <form id="tournamentForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="tournament_name">å¤§ä¼šå<span class="required">*</span></label>
            <input type="text" id="tournament_name" name="tournament_name" required 
                   value="{{ tournament.tournament_name }}">
        </div>
        
        <div class="form-group">
            <label for="date">é–‹å‚¬æ—¥<span class="required">*</span></label>
            <input type="date" id="date" name="date" required 
                   value="{{ tournament.date }}">
        </div>
        
        <div class="form-group">
            <label for="organizer">ä¸»å‚¬è€…<span class="required">*</span></label>
            <input type="text" id="organizer" name="organizer" required 
                   value="{{ tournament.organizer }}">
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="first_place">1ä½<span class="required">*</span></label>
                <input type="text" id="first_place" name="first_place" required 
                       value="{{ tournament.first_place }}">
            </div>
            
            <div class="form-group">
                <label for="second_place">2ä½</label>
                <input type="text" id="second_place" name="second_place" 
                       value="{{ tournament.second_place if tournament.second_place else '' }}">
            </div>
            
            <div class="form-group">
                <label for="third_place">3ä½</label>
                <input type="text" id="third_place" name="third_place" 
                       value="{{ tournament.third_place if tournament.third_place else '' }}">
            </div>
        </div>
        
        <div class="form-group">
            <label for="description">å¤§ä¼šè©³ç´°</label>
            <textarea id="description" name="description">{{ tournament.description if tournament.description else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="youtube_url_1">YouTubeå‹•ç”»URL 1</label>
            <input type="url" id="youtube_url_1" name="youtube_url_1" 
                   value="{{ tournament.youtube_url_1 if tournament.youtube_url_1 else '' }}"
                   placeholder="https://www.youtube.com/watch?v=...">
        </div>

        <div class="form-group">
            <label for="youtube_url_2">YouTubeå‹•ç”»URL 2</label>
            <input type="url" id="youtube_url_2" name="youtube_url_2" 
                   value="{{ tournament.youtube_url_2 if tournament.youtube_url_2 else '' }}"
                   placeholder="https://www.youtube.com/watch?v=...">
        </div>

        <div class="form-group">
            <label for="youtube_url_3">YouTubeå‹•ç”»URL 3</label>
            <input type="url" id="youtube_url_3" name="youtube_url_3" 
                   value="{{ tournament.youtube_url_3 if tournament.youtube_url_3 else '' }}"
                   placeholder="https://www.youtube.com/watch?v=...">
        </div>

        <div class="form-group">
            <label for="youtube_url_4">YouTubeå‹•ç”»URL 4</label>
            <input type="url" id="youtube_url_4" name="youtube_url_4" 
                   value="{{ tournament.youtube_url_4 if tournament.youtube_url_4 else '' }}"
                   placeholder="https://www.youtube.com/watch?v=...">
        </div>

        <div class="form-group">
            <label for="youtube_url_5">YouTubeå‹•ç”»URL 5</label>
            <input type="url" id="youtube_url_5" name="youtube_url_5" 
                   value="{{ tournament.youtube_url_5 if tournament.youtube_url_5 else '' }}"
                   placeholder="https://www.youtube.com/watch?v=...">
        </div>
        
        <div class="form-group">
            <label>ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ç”»åƒ</label>
            {% if tournament.bracket_image %}
            <p style="color: #7f8c8d; margin-bottom: 10px;">ç¾åœ¨ã®ç”»åƒ:</p>
            <img src="{{ url_for('static', filename='../uploads/' + tournament.bracket_image) }}" 
                 alt="ç¾åœ¨ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨" 
                 class="current-image">
            <p style="color: #7f8c8d; margin: 10px 0;">æ–°ã—ã„ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ç½®ãæ›ã‚ã‚Šã¾ã™</p>
            {% endif %}
            <div class="file-upload" id="fileUpload">
                <div class="upload-icon">ğŸ“Š</div>
                <p><strong>ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ–°ã—ã„ç”»åƒã‚’é¸æŠ</strong></p>
                <p style="color: #666; font-size: 0.9em; margin-top: 5px;">
                    PNG, JPG, GIF (æœ€å¤§16MB)
                </p>
                <p id="fileName" style="color: #66a6ff; font-weight: bold; margin-top: 10px;"></p>
                <input type="file" id="bracket_image" name="bracket_image" accept="image/*">
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn">ğŸ’¾ æ›´æ–°</button>
            <a href="/tournament/" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
        </div>
    </form>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>æ›´æ–°ä¸­...</p>
    </div>
    
    <div class="error" id="errorMsg"></div>
    <div class="success" id="successMsg"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const fileUpload = document.getElementById('fileUpload');
    const fileInput = document.getElementById('bracket_image');
    const fileName = document.getElementById('fileName');
    const form = document.getElementById('tournamentForm');
    const loading = document.getElementById('loading');
    const errorMsg = document.getElementById('errorMsg');
    const successMsg = document.getElementById('successMsg');
    
    fileUpload.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            fileName.textContent = `é¸æŠæ¸ˆã¿: ${e.target.files[0].name}`;
        }
    });
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        errorMsg.classList.remove('show');
        successMsg.classList.remove('show');
        loading.classList.add('show');
        
        const formData = new FormData(form);
        
        try {
            const response = await fetch('edit/{{ tournament.id }}', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                successMsg.textContent = 'âœ“ å¤§ä¼šæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼';
                successMsg.classList.add('show');
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1000);
            } else {
                throw new Error(data.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        } catch (error) {
            errorMsg.textContent = `âœ— ${error.message}`;
            errorMsg.classList.add('show');
        } finally {
            loading.classList.remove('show');
        }
    });
</script>
{% endblock %}
